[source,bash,subs="attributes+"]
----
job_name="{http-method}-silence-{argo_app}-alerts-$(date +%s)"
ifeval::["{http-method}" == "POST"]
silence_duration='{duration}' <1>
endif::[]
kubectl --as=cluster-admin -n openshift-monitoring create -f- <<EOJ
apiVersion: batch/v1
kind: Job
metadata:
  name: ${job_name}
  labels:
    app: silence-{argo_app}-alerts
spec:
 backoffLimit: 0
 template:
  spec:
    restartPolicy: Never
    containers:
      - name: silence
        image: quay.io/appuio/oc:v4.6
        command:
        - bash
        - -c
        - |
          curl_opts=( --cacert /etc/ssl/certs/serving-certs/service-ca.crt --header "Content-Type: application/json" --header "Authorization: Bearer \$(cat /var/run/secrets/kubernetes.io/serviceaccount/token)" --resolve alertmanager-main.openshift-monitoring.svc.cluster.local:9095:\$(getent hosts alertmanager-operated.openshift-monitoring.svc.cluster.local | awk '{print \$1}' | head -n 1) --silent )
ifeval::["{http-method}" == "POST"]
          read -d "" body << EOF
          {
            "matchers": [
              {
                "name": "syn_component",
                "value": "{argo_app}",
                "isRegex": false
              }
            ],
            "startsAt": "$(date -u +'%Y-%m-%dT%H:%M:%S')",
            "endsAt": "$(date -u +'%Y-%m-%dT%H:%M:%S' --date "${silence_duration}")",
            "createdBy": "$(kubectl config current-context | cut -d/ -f3)",
            "comment": "Silence all {argo_app} alerts"
          }
          EOF

endif::[]
          curl "\${curl_opts[@]}" \
            "https://alertmanager-main.openshift-monitoring.svc.cluster.local:9095{alertmanager-endpoint}" \
ifeval::["{http-method}" == "POST"]
            -X{http-method} -d "\${body}"
endif::[]
ifeval::["{http-method}" != "POST"]
            -X{http-method}
endif::[]

        volumeMounts:
        - mountPath: /etc/ssl/certs/serving-certs/
          name: ca-bundle
          readOnly: true
    serviceAccountName: prometheus-k8s
    volumes:
    - name: ca-bundle
      configMap:
        defaultMode: 288
        name: serving-certs-ca-bundle
EOJ
----
ifeval::["{http-method}" == "POST"]
<1> Adjust this variable to create a longer or shorter silence
endif::[]
